# Communications dans un r√©seau des capteurs LoRaWAN

[Pr√©c√©dent](06.md) | [Sommaire](README.md) |  [Suivant](07b.md)

Dans ce chapitre, vous apprendrez √† transmettre et recevoir des informations vers des applications sur des serveurs en utilisant les services d'une infrastructure LoRaWAN.

## Rappel

> Configurez la carte cible pour `make`
```bash
export BOARD=wyres-base
export EXTERNAL_BOARD_DIRS=~/github/campusiot/RIOT-wyres/boards
```

Recherchez le  `tty` de la console et connectez-vous √† celle-ci avec `tio`.

Sur Linux
```bash
lsusb
tio
tio -b 115200 -m INLCRNL /dev/ttyUSB0
```

Sur MacOS
```bash
lsusb
tio
tio -L
tio -b 115200 -m INLCRNL /dev/tty.usbserial-XXXX
```

> Pour m√©moire, si vous utilisez Linux dans une machine virtuelle VirtualBox, il faut monter les 2 p√©riph√©riques USBSerial et STLink dans le menu P√©rip√©riques de la machine virutelle.


## L'infrastructure LoRaWAN

Les r√©seaux LoRaWAN ont une topologie dite en √©toile. Les √©quipemnts ne dialoguent qu'avec les stations de base (cf. figure de gauche). Les √©quipements ne dialoguent pas entre-eux comme dans les r√©seaux maill√©s (cf. figure √† droite).

![topologie](images/topologie-01.png)

Dans un r√©seau LoRaWAN, toutes les stations de base √©coutent (et transmettent) sur les m√™mes canaux d'une bande de fr√©quence. De ce fait, un message √©mis par un √©quipement peut √™tre re√ßu par une √† plusieurs stations. Le serveur du r√©seau est en charge de d√©dupliquer les duplicats d'un m√™me message. Dans le cas o√π un √©quipement est entendu par plusieurs stations, la panne d'une d'entre elles ne cr√©e par d'interuption de la collecte des mesures (cf. le sch√©ma suivant).

![topologie](images/topologie-02.png)

### Les √©l√©ments

Les √©quipements d'un r√©seau LoRaWAN sont: 
* Terminal (Endpoint ou Device en anglais)
* Point d‚Äôacc√®s ou Station de Base ou Passerelle (Gateway en anglais)
* Join Server
* Network Server
* App Server

![Infra LoRaWAN](images/infra-lorawan-02.png)

Les √©quipements utilisent les [chirps](https://fr.wikipedia.org/wiki/Chirp) montants (polarit√© normale) pour transmettre et les √©quipements utilisent les chirps descendants (polarit√© invers√©e) pour transmettre. Cela √©vite que les √©quipements s'entendent entre eux et Cela √©vite que les stations s'entendent entre elles.

> Pour m√©moire, dans le chapitre pr√©c√©dent, les √©quipements LoRaChat s'entendaient entre eux !


![Polarit√©](images/polarite.png)


### Les identifiants et les cl√©s

L'activation (OTAA) utilise les informations suivantes pour authentifier un √©quipement aupr√®s d'un r√©seau d'op√©rateur:
* L'identifiant unique d'√©quipement `DevEUI` dont le pr√©fixe est norlmalement l'identifiant unique de fabricant([`OUI`](https://fr.wikipedia.org/wiki/Organizationally_Unique_Identifier))
* `AppEUI` / `JoinEUI` qui sert aux √©quipements vagabonds (roaming en anglais)
* `AppKey` la cl√© dite applicative qui sert √† authentifier l'√©quipement aupr√®s du serveur du r√©seau et qui sert √† authentifier le serveur du r√©seau dans lequel l'√©quipement est cens√© √™tre enregist√© par son propri√©taire.

A l'issue de la proc√©dure d'activation, l'√©quipement recoit un identifiant dans le r√©seau, le `DevAddr`. Cet identifant est normalement pris dans une plage d'adresse affect√©e √† un op√©rateur LoRaWAN par la LoRa Alliance. Cette plage se calcule √† partir du [`NetId`](https://www.thethingsnetwork.org/docs/lorawan/prefix-assignments/). Deux `NetId` sont r√©serv√©s aux r√©seaux exp√©rimentaux (`00`,`01`).

Note: Sur Grenoble, les `NetId`s que vous pourrez observer les plus fr√©quemment dans la console des stations sont
* `000007` pour Objenious rach√©t√© par NetMore (`DevAddr compris entre `0E000000` et `0FFFFFFF`).
* `00000F` pour LiveObject (Orange) (`DevAddr compris entre `1E000000` et `1FFFFFFF`).
* `000013` pour The Things Network (`DevAddr compris entre `26000000` et `27FFFFFF`).
* `C0002B` pour l'Universit√© Grenoble Alpes (`DevAddr compris entre `FC00AC00` et `FC00AFFF`).

La suite des √©changes est s√©curis√©e au moyen de deux cl√©s : la cl√© de session r√©seau `NwkSKey` qui sert √† signer (et donc autentifier) les messages et la cl√© de session applicative `AppSKey` qui sert √† chiffrer (donc rendre confidentiel) la charge utile (ou applicative) du message.

### Les classes d'objet

* La classe A pour un terminal autonome en √©nergie (batteries). R√©ception du message descendant (downlink) 1 seconde exactement apr√®s la fin de la transmission d‚Äôun message montant
* La classe B pour un terminal autonome en √©nergie (batteries). Ecoute p√©riodique (8 fois / 128 secondes) d‚Äôun canal pour la r√©ception du message descendant (downlink). Synchronisation r√©guli√®re de l‚Äôoscillateur du terminal avec un ‚Äúbeacon‚Äù pour corriger sa d√©rive
* La classe C pour un terminal autonome en √©nergie (batteries). Ecoute permanente d‚Äôun canal pour la r√©ception du message descendant (downlink)
* La classe C Multicast : pour proc√©der notamment √† la mise √† jour d'un parc d'√©quipement

## Envoi d'information vers l'infrastructure LoRaWAN

Pour que votre carte puisse transmettre des informations, il faut enregistrer un √©quipement dans une application sur le serveur de l'infrastructure LoRaWAN de CampusIoT (via la console Web).


G√©n√©rez premi√®rement un identifiant unique (`DevEUI`) et une cl√© secrete AES128 (`AppKey`).

```bash
DevEUI=`echo "CAFEBABE$(openssl rand -hex 4)"`
AppKey=`openssl rand -hex 16`
echo $DevEUI
echo $AppKey
```
> Note: La probabilit√© de collisions des DevEUI entre vous est de 1 sur 2^32.

Connectez-vous √† la [console web du serveur LoRaWAN](https://lns.campusiot.imag.fr) avec vos identifiants donn√©s en cours.

Cherchez l'application qui correspond √† votre num√©ro de groupe.

Enregistrez un nouvel √©quipement dans l'application cr√©√©e pour votre √©quipe depuis votre console Web en utilisant l'identifiant unique (`DevEUI`) et la cl√© secrete AES128 (`AppKey`) g√©n√©r√©s. Il faut choisir  `OTAA_CLASS_A_TEXT` pour le Device Profile qui utilise la fonction de d√©codage suivante:

```javascript
// Decode decodes an array of bytes into an object.
//  - fPort contains the LoRaWAN fPort number
//  - bytes is an array of bytes, e.g. [225, 230, 255, 0]
//  - variables contains the device variables e.g. {"calibration": "3.5"} (both the key / value are of type string)
// The function must return an object, e.g. {"temperature": 22.5}
function Decode(fPort, bytes, variables) {
  	var result = "";
	for(var i = 0; i < bytes.length; ++i){
		result+= (String.fromCharCode(bytes[i]));
	}
	var decoded = { text: result };
  	return decoded;
}
```

> Si le Device Profile `OTAA_CLASS_A_TEXT` n'apparait pas dans la liste, cr√©ez un profil pour votre organisation en utilisant la fonction de d√©codage ci-dessus.

Cr√©ez un nouvel √©quipement depuis l'application qui vous a √©t√© affect√©e en renseignant le `DevEUI` g√©n√©r√©

![Create Device](images/create_device_01.png)

Renseignez l'`AppKey` g√©n√©r√©e

![Create Device](images/create_device_02.png)

L'√©quipement est cr√©e dans l'application

![Create Device](images/create_device_03.png)

Flashez la carte avec le programme suivant

```bash
cd ~/github/campusiot/RIOT-wyres/tests/pkg_semtech-loramac
make -j 4 flash
```

Si je vous ai fourni une carte d√©j√† flash√© avec le firmware `pkg_semtech-loramac.bin`, ex√©cutez les commandes suivantes:
```bash
cd ~/github/campusiot/RIOT-wyres/tests/pkg_semtech-loramac
ls -l /dev/ttyUSB0
sudo chmod 666 /dev/ttyUSB0
make term
```

Lancez les commandes depuis le console `tio` qui est connect√©e √† votre carte via son interface UART (console):

```console
help
loramac
loramac set
# echo "CAFEBABE$(openssl rand -hex 4)"
loramac set deveui CAFEBABE123456xx
loramac set appeui CAFEBABE00000000
# openssl rand -hex 16
loramac set appkey e5ecb6ede7add13fea9816af42aaxxxx
loramac save
loramac set dr 5
loramac set adr on
loramac join otaa
loramac tx HELLO\ YAOUNDE cnf 10
loramac link_check
# Link check request scheduled
loramac tx HELLO\ YAOUNDE uncnf 10
loramac tx HELLO\ YAOUNDE cnf 10
loramac link_check
# Link check request scheduled
loramac tx HELLO\ YAOUNDE uncnf 10
```

En parall√®le, vous observez les messages recus et envoy√©s par le serveur depuis l'onglet `LORAWAN FRAMES`  de la console Web

![Join and Uplinks](images/join_uplinks.png)

Vous observerez le `DevAddr`, les 2 cl√©s de session `AppSKey`  et `NwkSKey`utilis√©es d√©sormais par la carte et le serevur pour s√©curiser les √©changes (uplink et downlink) ainsi que la valeur des 2 compteurs (**uplink** et **downlink**)

V√©rifiez que ce sont bien les m√™mes du c√¥t√© de la carte

```console
loramac get devaddr
loramac get nwkskey
loramac get appskey
loramac get ul_cnt
```

![Activation](images/activation.png)

Vous observez la charge utile d√©cod√©e dans le messages recu depuis l'onglet `DEVICE DATA`  de la console Web

```console
loramac tx HELLO\ YAOUNDE uncnf 10
```

![Decoded](images/decoded.png)

## R√©ception d'information depuis l'infrastructure LoRaWAN CampusIoT

Les applications qui consomment les mesures des capteurs des √©quipements, peuvent √™tre envoy√©s des messages (downlink) vers les √©quipements. Ces messages peuvent √™tre des param√™tres de reconfiguration du capteur, ou bien des commandes vers une des actionneurs de la carte. Dans le cas de la carte Wyres Base, les deux actionneurs sont la paire de LED et le PWM qui commande le haut parleur.

Depuis un Shell, encodez en Base64 un message de texte:

```bash
echo "Hello Wyres Base" | base64
SGVsbG8gV3lyZXMgQmFzZQo=
```

Ouvrez l'onglet Detail de votre √©quipement et ajoutez le texte encod√© dans la boite `Enqueue downlink payload` comme ci-dessous.

![Schedule Downlink](images/schedule_downlink-01.png)

Le message destin√© √† l'√©quipement est mis en file d'attente. Le serveur repondra √† l'√©quipement 1 seconde apr√®s la prochaine √©mission de la carte.

![Schedule Downlink](images/schedule_downlink-02.png)

Depuis la console de la carte, envoyez un message sans confirmation. Le serveur r√©pond avec le message en attente. La carte affiche le message recu `Hello Wyres Base`.

```console
> loramac tx HELLO\ WORLD uncnf 14
Data received: Hello Wyres Base
, port: 110
Message sent with success
```

![Schedule Downlink](images/schedule_downlink-03.png)


> Exercice (optionel) : modifiez le code de l'exemple `pkg_semtech-loramac` pour que la carte joue une petite partition de musique quand elle re√ßoit un message sur le port `33`, la partition est une chaine de caract√®res pass√©e dans la charge utile. `A`, `B`, `C`, `D`, `E`, `F`, `G`, pour les notes `la` `si`, `do`, `r√©`, `mi`, `fa`, `sol` et en suffixe de chaque note, la dur√©e avec : 0 pour une demi croche (1/4 de temps); 1 pour une croche (1/2 de temps); 2 pour une noire (1 temps); 3 pour une blanche (2 temps); 4 pour une ronde (4 temps).

## R√©ception d'information depuis l'infrastructure LoRaWAN CampusIoT quand l'√©quipement est en classe C

R√©-enregistrez l'√©quipement avec le Device Profile `OTAA_CLASS_C_NOCODEC`.

```console
> reboot
> loramac set dr 5
> loramac set adr on
> loramac join otaa
> loramac get class
> loramac set class C
```

Depuis un Shell, encodez en Base64 un nouveau message de texte:

```bash
echo "Hello Wyres Base (Class C)" | base64
SGVsbG8gV3lyZXMgQmFzZSAoQ2xhc3MgQykK
```

Ouvrez l'onglet Detail de votre √©quipement et ajoutez le texte encod√© `SGVsbG8gV3lyZXMgQmFzZSAoQ2xhc3MgQykK` dans la boite `Enqueue downlink payload` comme pr√©c√©denment.

Refraichissez l'√©tat de la file de message `Downlink queue` : le message a √©t√© envoy√© par le serveur

Mais la console n'affiche pas le message ! Que s'est il pass√© ?

Reconfigurez les param√™tres suivants:

```console
> loramac get rx2_freq
RX2 freq: 869525000
> loramac get rx2_dr
RX2 dr: 0
> loramac set rx2_dr 3
> loramac get rx2_dr
RX2 dr: 3
```

A quoi correspond les param√™tres `rx2_freq` et `rx2_dr` ?

Ouvrez de nouveau l'onglet Detail de votre √©quipement et ajoutez le texte encod√© `SGVsbG8gV3lyZXMgQmFzZSAoQ2xhc3MgQykK` dans la boite `Enqueue downlink payload` comme pr√©c√©denment.

Que se passe t'il ?


## Cayenne LPP

Cayenne LPP (Low Power Payload) est un format d'encodage des mesures de capteurs dans la charge utile d'un message LoRaWAN. Chaque mesure est attach√©e √† un canal (0..255) et elle est typ√©e (temperature en ¬∞C, humidit√© relative en %RH, position GPS ...). Ce format qui est auto-descriptif a l'avantage d'√™tre directement utilisable par un d√©codeur g√©n√©rique (`OTAA_CLASS_A_LPP` de votre organisation et par des plateformes de stockage et de visualisation comme myDevices que nous verrons dans le chapitre suivant.

> Note: les fabricants d'√©quipements lui pr√©f√®rent des formats plus compacts mais propri√©taires pour all√©ger au maximum la charge utile des messages (donc la dur√©e de la transmission et la dur√©e de vie des batteries des √©quipements). Un catalogue des decodeurs d'√©quipements commerciaux est disponible [ici](https://github.com/TheThingsNetwork/lorawan-devices).

Le programme suivant g√©n√®re quels points de mesure similant la trajectoire d'un ballon stratosph√©rique.

```bash
cd ~/github/campusiot/RIOT-wyres/tests/cayenne-lpp
make -j 4
```

```console
main(): This is RIOT! (Version: 2023.07-devel-325-g2863d)

==== Point #1 ====
temperature=20.00
humidity=100.0
pressure=900
luninosity=1000.0
latitude=46.50000 longitude=5.50000 altitude=18000
battery_voltage=3600.0
LPP: : 016700C80268C803732328046503E8058807186800D6D81B774006027E40

==== Point #2 ====
temperature=20.00
humidity=100.0
pressure=900
luninosity=1000.0
latitude=46.50000 longitude=5.50349 altitude=18000
battery_voltage=3600.0
LPP: : 016700C70268C703732327043C03E7058807186800D6FA1B773E06027E3F

```

Reflashez l'exemple `pkg_semtech-loramac` (le firmware est inchang√©)

```bash
cd ~/github/campusiot/RIOT-wyres/tests/pkg_semtech-loramac
make -j 4 flash-only
```

Changez cependant le Device Profile par `OTAA_CLASS_A_LPP` dans la console Web

Utilisez les cha√Ænes hexad√©cimales LPP g√©n√©r√©es pour simuler un ballon stratosph√©rique.

```
> reboot
> loramac set dr 5
> loramac set adr on
> loramac join otaa
...
> loramac_txhex 016700C80268C803732328046503E8058807186800D6D81B774006027E40 uncnf 10
> loramac_txhex 016700C70268C703732327043C03E7058807186800D6FA1B773E06027E3F uncnf 10
...
```

> Note: Les `DevEUI`, `AppEUI` et `AppKey` ont √©t√© conserv√©s en EEPROM grace √† la commande `loramac save`.

Vous observez la charge utile d√©cod√©e dans le messages recu depuis l'onglet `DEVICE DATA`  de la console Web

![Decoded](images/decoded_lpp.png)


## Un exemple assez complet : un Field Test Device utilis√© √† bord de ballons sondes

Les Field Test Device ou testeur de couverture de terrain sont des √©quipements utilis√©s par les installateurs de r√©seaux LoRaWAN (capteurs et stations) peuvent mesurer et cartographier la couverture radio et la qualit√© des liens entre les √©quipements √† installer et les stations existantes.

### Field Test Device (sans module GNSS)

Le programme ci-dessous a √©t√© utilis√© pour effectuer des [tests de couverture √† tr√®s haute altitude (jusqu'√† 30 kms) au bord de ballons sonde](https://gricad-gitlab.univ-grenoble-alpes.fr/thingsat/public/-/blob/master/balloons/README.md) √† pour d√©terminer la port√©e potentiele des communications LoRa.

G√©n√©rez premi√®rement un nouvel identifiant unique (`DevEUI`) et une cl√© secrete AES128 (`AppKey`).

```bash
DevEUI=`echo "CAFEBABE$(openssl rand -hex 4)"``
AppKey=`openssl rand -hex 16`
echo $DevEUI
echo $AppKey
```

Cr√©ez un nouvel √©quipement `WYRES_123_12345679_BALLOON` avec l'dentifiant `DevEUI` et la cl√© AES128 (`AppKey`) g√©n√©r√©s et avec le Device Profile `OTAA_CLASS_A_BALLOON` ([codec](https://github.com/CampusIoT/RIOT-wyres/blob/main/apps/field_test_device/codec/decoder_lns.js))

```bash
cd ~/github/campusiot/RIOT-wyres/apps/field_test_device
AppEUI=CAFEBABE00000000
make DEVEUI=$DevEUI APPEUI=$AppEUI APPKEY=$AppKey OPERATOR=CampusIoT TXPERIOD=60 flash
```

<details>
<summary>Console (tio)</summary>
main(): This is RIOT! (Version: 2b19330--dirty)
Application: field-test-device
Version: 	2b19330--dirty
Commit SHA1: 2b1933015ce40a7c9f9592e2292d6073ab68441a
Commit date: 2023-11-08T22:16:19+01:00
Build date:  2023-11-10T09:26:06Z
WDT started
[clock] Current RTC time :   2020-01-01 00:07:23
[clock] Last correction  : never
[info] CpuId:33374701303738370067a06a
[info] Operator: Undefined
[mac] Region: EU868
[mac] DutyCycle: disabled
[otaa] DevEUI:cafebabe12345679
[otaa] AppEUI:cafebabe00000000
[otaa] AppKey:af42aa7bedbed13efea9816cb6ede7ad
[otaa] Starting join procedure: dr=5
[otaa] Join procedure succeeded
[otaa] DevAddr: fc00aed5
[otaa] NwkSKey:3c1c8772e97ec553244dafc336e08b3a
[otaa] AppSKey:88447cc8363cb775be075f3cc507a794
[otaa] Network: Unknown
[clock] Current RTC time :   2020-01-01 00:07:28
[clock] Last correction  : never
[clock] app_clock_send_app_time_req
[clock] Current time:   2020-01-01 00:07:58
[clock] app_clock_process_downlink
[clock] APP_CLOCK_CID_AppTimeAns
[clock] Current time	:   2020-01-01 00:07:59
[clock] Time Correction : 121771160
[clock] RTC time fixed  :   2023-11-10 09:27:19
[clock] sent_buffer:
[clock] app_clock_send_buffer
[clock] Current RTC time :   2023-11-10 09:27:19
[clock] Last correction  :   2023-11-10 09:27:19
[ftd] Start benchmark
[ftd] New benchmark sequence: port=2
[ftd] Send @ devaddr=d5ae00fc port=2 dr=0 txpower=14 size=8
[ftd] Tx Done ret=6 fcnt=2
[ftd] Send @ devaddr=d5ae00fc port=2 dr=0 txpower=14 size=32
[ftd] Tx Done ret=6 fcnt=3
[ftd] Send @ devaddr=d5ae00fc port=2 dr=0 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=4
[ftd] Send @ devaddr=d5ae00fc port=2 dr=1 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=5
[ftd] Send @ devaddr=d5ae00fc port=2 dr=2 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=6
[ftd] Send @ devaddr=d5ae00fc port=2 dr=3 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=7
[ftd] Send @ devaddr=d5ae00fc port=2 dr=4 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=8
[ftd] Send @ devaddr=d5ae00fc port=2 dr=5 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=9
[dn] Link check information:
  - Demodulation margin: 10
  - Number of gateways: 3
[ftd] Send @ devaddr=d5ae00fc port=2 dr=5 txpower=1 size=16
[ftd] Tx Done ret=6 fcnt=10
[ftd] Send @ devaddr=d5ae00fc port=2 dr=5 txpower=8 size=16
[ftd] Tx Done ret=6 fcnt=11
[ftd] Send @ devaddr=d5ae00fc port=2 dr=5 txpower=5 size=16
[ftd] Tx Done ret=6 fcnt=12
[ftd] Send @ devaddr=d5ae00fc port=2 dr=5 txpower=2 size=16
[ftd] Tx Done ret=6 fcnt=13
[ftd] New benchmark sequence: port=3
[ftd] Send @ devaddr=d5ae00fc port=3 dr=0 txpower=14 size=8
[ftd] Tx Done ret=6 fcnt=14
[ftd] Send @ devaddr=d5ae00fc port=3 dr=0 txpower=14 size=32
[ftd] Tx Done ret=6 fcnt=15
[ftd] Send @ devaddr=d5ae00fc port=3 dr=0 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=16
[ftd] Send @ devaddr=d5ae00fc port=3 dr=1 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=17
[ftd] Send @ devaddr=d5ae00fc port=3 dr=2 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=18
[ftd] Send @ devaddr=d5ae00fc port=3 dr=3 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=19
[ftd] Send @ devaddr=d5ae00fc port=3 dr=4 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=20
[ftd] Send @ devaddr=d5ae00fc port=3 dr=5 txpower=14 size=16
[ftd] Tx Done ret=6 fcnt=21
[ftd] Send @ devaddr=d5ae00fc port=3 dr=5 txpower=1 size=16
[ftd] Tx Done ret=6 fcnt=22
[ftd] Send @ devaddr=d5ae00fc port=3 dr=5 txpower=8 size=16
[ftd] Tx Done ret=6 fcnt=23
[ftd] Send @ devaddr=d5ae00fc port=3 dr=5 txpower=5 size=16
[ftd] Tx Done ret=6 fcnt=24
[ftd] Send @ devaddr=d5ae00fc port=3 dr=5 txpower=2 size=16
[ftd] Tx Done ret=6 fcnt=25
[clock] app_clock_send_app_time_req
[clock] Current time:   2023-11-10 09:41:47
[clock] app_clock_process_downlink
[clock] APP_CLOCK_CID_AppTimeAns
[clock] Current time	:   2023-11-10 09:41:48
[clock] Time Correction : 1
[clock] RTC time fixed  :   2023-11-10 09:41:49
[clock] sent_buffer:
[clock] app_clock_send_buffer
[clock] Current RTC time :   2023-11-10 09:41:49
[clock] Last correction  :   2023-11-10 09:41:49
</details>

> Note : dans l'exemple pr√©c√©dent, le firmware demande p√©riodiquement au serveur LoRaWAN de recaler son horloge temps r√©el (RTC)

### Field Test Device (avec module GNSS)

Pour inclure dans la charge utile du message la position de l'objet lors de l'√©mission, il convient de connecter l'interface UART du module GNSS au connecteur Grove UART utilis√© normalement par la console et de refabriquer le firmware en modifiant le fichier `Makefile.device` de la mani√®re suivante.

```makefile
GPS = 1

ifeq ($(GPS),1)
STD_BAUDRATE = 9600
endif
```

Il n'est alors plus possible d'utiliser la console.

> Note: le d√©bit (baudrate) par d√©faut des modules GNSS varie d'un mod√®le √† l'autre. Vous trouverez la configuration des mod√®les courants dans cette [liste](https://github.com/CampusIoT/orbimote/blob/master/gnss_modules.md).

![Wyres + GNSS](images/wyres-gnss-uart.jpg)

## Id√©e de mini-projet 

En repartant du code de l'exemple Field Test Device, utilisez SAUL pour collecter les mesures de capteurs branch√©s et utilisez Cayenne LPP pour encoder le message √† envoyer vers l'infrastructure LoRaWAN.

Changez le Device Profile par `OTAA_CLASS_A_LPP` pour votre √©quipement.

## Id√©e de mini-projet : [Minitel](https://fr.wikipedia.org/wiki/Minitel) üì∫ LoRaWAN Class C

L'id√©e de ce mini-projet est de recycler un minitel (chin√© dans une brocante ou sur le Bon Coin) pour chatter via un r√©seau LoRaWAN.

A partir des exemples pr√©c√©dents, interfacez la carte Wyres par le port UART au port du Minitel üì∫ via la carte d'adaptation des niveau de tension 12V0 -> 3V3 pour envoyer des messages dans des paquets LoRaWAN et pour afficher les messsages texte recus.

La carte reli√©e au minitel doit √™tre enregistr√©e en classe C avec ce Device Profile `OTAA_CLASS_A_TEXT`. 

En compl√©ment, vous pouvez aussi compl√©ter le texte du message √† envoyer avec:
* la temp√©rature (en `¬∞C`) relev√©e par la carte quand `%c` se trouve dans le message texte √† envoyer
* la temp√©rature (en `¬∞F`) relev√©e par la carte quand `%f` se trouve dans le message texte √† envoyer
* la pression relev√©e par la carte quand `%p` se trouve dans le message texte √† envoyer
* l'orientation relev√©e par l'acc√©lerom√®tre de la carte quand `%o` se trouve dans le message texte √† envoyer
* la tension de l'alimentation (VBat) relev√©e par la carte quand `%v` se trouve dans le message texte √† envoyer
* le date  de la RTC de la carte au format `YYYY-MM-DD` quand `%D` se trouve dans le message texte √† envoyer.
* l'heure de la RTC de la carte au format `HH:MM:SS` quand `%H` se trouve dans le message texte √† envoyer. 
* ...
* l'ensemble des mesures quand `%a` se trouve dans le message texte √† envoyer

La carte synchronise sa RTC au moyen de la sp√©cification `App Clock Sync`.

`help` affiche la banni√®re et l'aide

![](images/minitel-wyres-lorawan.jpg)
Cr√©dit photo: Nicolas Picaud

Testez les messages suivant:
```
Nous sommes le %D et il est %H.
La temp√©rature est de %c ¬∞C et la pression atmospherique est de %p hPa.
La tension d'alimentation est %v mV.
```

En compl√©ment, d√©veloppez un flot Nodered qui envoie en donwlink un message recu √† chaque minitel identifi√© dans le message recu par des sous-chaine pr√©fix√©e par `@`. 

> Remarque: ce type de chat est un d√©but de solution pour op√©rer un r√©seau d'urgence en cas de catastrophe (aka [disaster network](https://air.imag.fr/index.php/Disaster_Networking_with_LoRa))

## Que faire si nous n'avez pas de stations CampusIoT √† proximit√© de vos √©quipements ?

L'infrastructure LoRaWAN CampusIoT est op√©r√© par le Laboratoire d'Informatique de Grenoble (LIG UMR CNRS 5217) de l'Universit√© Grenoble Alpes.

Si vous n'√™tes pas √† proximit√© d'une station LoRa communiquant avec CampusIoT, vous pouvez tenter d'enregistrer votre √©quipement soit aupr√®s du r√©seau collaboratif [TheThingsNetwork](https://eu1.cloud.thethings.network/console/) (gratuit mais pas d'utilisation commerciale) soit aupr√®s du r√©seau crowd-sourc√© [Helium](https://console.helium.com) (gratuit jusqu'√† 10 √©quipements et ~10000 messages).
